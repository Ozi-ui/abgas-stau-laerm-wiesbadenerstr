<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Lärmpegel-Auswertung</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; background: #f7f7f7; margin: 40px; }
        h2 { margin-top: 40px; }
        #container { max-width: 800px; margin: auto; background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 0 8px #ccc; }
        .chart-block { margin-bottom: 50px; }
        .input-row { margin-bottom: 15px; display: flex; align-items: center; flex-wrap: wrap;}
        .nav { margin-bottom: 30px; background: #224e7a; color: #fff; padding: 14px 24px; border-radius: 6px;}
        .nav a { color: #fff; margin-right: 30px; text-decoration: none; font-weight: bold;}
        .nav a:hover { text-decoration: underline; }
        .input-row label { margin-right: 8px; }
        .btn-group button {margin-right: 8px;}
        @media (max-width: 600px) {
            #container { padding: 5vw; }
            .input-row { flex-direction: column; align-items: stretch;}
            .btn-group { margin: 10px 0;}
        }
    </style>
</head>
<body>
<div id="container">
    <div class="nav">
        <a href="index.html">Start</a>
        <a href="laerm.html">Lärmpegel</a>
        <a href="abgas.html">Abgas</a>
        <a href="stau.html">Stau</a>
        <!-- weitere Links je nach Bedarf -->
    </div>
    <h1>Lärmpegel Monitoring</h1>

    <div class="chart-block">
        <h2>Lärmpegel (Live, alle 5 Minuten aktualisiert)</h2>
        <p>WHO-Grenzwerte: 55 dB (Empfehlung), 65 dB (kritisch), 70 dB (gesundheitsschädlich)</p>
        <canvas id="laermpegel-live" height="80"></canvas>
    </div>

    <div class="chart-block">
        <h2>Historische Lärmpegel-Auswertung</h2>
        <div class="input-row">
            <div class="btn-group">
                <button onclick="setZeitraumPreset(10)">10 Min</button>
                <button onclick="setZeitraumPreset(30)">30 Min</button>
                <button onclick="setZeitraumPreset(60)">1 Stunde</button>
                <button onclick="setZeitraumPreset(360)">6 Stunden</button>
                <button onclick="setZeitraumPreset(720)">12 Stunden</button>
                <button onclick="setZeitraumPreset(1440)">24 Stunden</button>
            </div>
            <span style="margin-left:24px; margin-right:8px;">oder Zeitraum:</span>
            <label for="von">von:</label>
            <input type="datetime-local" id="von" style="margin-right:8px;">
            <label for="bis">bis:</label>
            <input type="datetime-local" id="bis" style="margin-right:8px;">
            <button onclick="zeitraumVonBis()">Anwenden</button>
        </div>
        <canvas id="laermpegel-historic" height="80"></canvas>
    </div>
</div>

<script>
// Chart.js Plugin für farbige Schwellenbereiche (ähnlich Plotly shapes)
const backgroundRangesPlugin = {
    id: 'backgroundRanges',
    beforeDatasetsDraw: (chart) => {
        const { ctx, chartArea, scales } = chart;
        if (!chartArea) return;
        // Bereiche: [unten, oben, Farbe, Opazität]
        const ranges = [
            [40, 55, 'green', 0.09],
            [55, 65, 'yellow', 0.08],
            [65, 70, 'orange', 0.08],
            [70, 100, 'red', 0.07]
        ];
        ranges.forEach(([yMin, yMax, color, alpha]) => {
            ctx.save();
            ctx.globalAlpha = alpha;
            ctx.fillStyle = color;
            // Bereich in Pixel umrechnen (y0/y1 in px)
            const y0 = scales.y.getPixelForValue(yMax);
            const y1 = scales.y.getPixelForValue(yMin);
            ctx.fillRect(chartArea.left, y0, chartArea.right - chartArea.left, y1 - y0);
            ctx.restore();
        });
    }
};

let alleLabels = [];
let alleDaten = [];
let alleRawLabels = []; // für Zeitfilter
let alleRawDaten = [];

async function fetchPegelDaten() {
    const response = await fetch('Daten/pegel.txt');
    const text = await response.text();
    const lines = text.trim().split('\n');
    const labels = [];
    const daten = [];
    lines.forEach(line => {
        // Nur Jahr-Monat-Tag Stunde:Minute extrahieren, Sekunden werden ignoriert
        const match = line.match(/^(\d{4}-\d{2}-\d{2} \d{2}:\d{2}):\d{2} - (?:Maximaler|Aktueller) Pegel: ([0-9.]+) dB$/);
        if (match) {
            labels.push(match[1]); // 'YYYY-MM-DD HH:MM'
            daten.push(parseFloat(match[2]));
        }
    });
    return {labels, daten};
}

function genGrenzwertArray(wert, len) {
    return Array(len).fill(wert);
}

let liveChart;
let historicChart;

// Zeitauswahl-Helper
function setZeitraumPreset(minuten) {
    // Setzt die letzten X Minuten als Filter
    document.getElementById('von').value = '';
    document.getElementById('bis').value = '';
    updateHistoricChartPreset(minuten);
}

function updateHistoricChartPreset(minuten) {
    // Zeigt die letzten X Minuten an
    const now = new Date();
    const msBack = minuten * 60 * 1000;
    const timeBack = new Date(now.getTime() - msBack);

    // alleRawLabels ist Array aus 'YYYY-MM-DD HH:MM'
    // Wir suchen Entries >= timeBack bis zum aktuellsten (letzter Wert)
    const filteredIdx = alleRawLabels
        .map((label, idx) => ({label, idx}))
        .filter(obj => {
            // label: 'YYYY-MM-DD HH:MM' -> 'YYYY-MM-DDTHH:MM'
            const d = new Date(obj.label.replace(' ', 'T'));
            return d >= timeBack;
        })
        .map(obj => obj.idx);

    let labels = [];
    let daten = [];
    if (filteredIdx.length > 0) {
        labels = filteredIdx.map(i => alleRawLabels[i].substring(11));
        daten = filteredIdx.map(i => alleRawDaten[i]);
    }

    renderHistoricChart(labels, daten);
}

function zeitraumVonBis() {
    // Holt Werte zwischen von und bis
    const von = document.getElementById('von').value;
    const bis = document.getElementById('bis').value;
    if (!von || !bis) {
        alert("Bitte 'von' und 'bis' Datum/Zeit wählen.");
        return;
    }
    // von und bis sind im Format "YYYY-MM-DDTHH:MM"
    // alleRawLabels sind "YYYY-MM-DD HH:MM"
    // Wir ersetzen das ' ' durch 'T' zum Vergleich
    const vonDate = new Date(von);
    const bisDate = new Date(bis);

    const filteredIdx = alleRawLabels
        .map((label, idx) => ({label, idx}))
        .filter(obj => {
            const d = new Date(obj.label.replace(' ', 'T'));
            return d >= vonDate && d <= bisDate;
        })
        .map(obj => obj.idx);

    let labels = [];
    let daten = [];
    if (filteredIdx.length > 0) {
        labels = filteredIdx.map(i => alleRawLabels[i].substring(11));
        daten = filteredIdx.map(i => alleRawDaten[i]);
    }

    renderHistoricChart(labels, daten);
}

async function ladePegelDaten() {
    const { labels, daten } = await fetchPegelDaten();
    alleLabels = labels.slice(-10); // Für Live-Chart: letzte 10
    alleDaten = daten.slice(-10);
    alleRawLabels = labels;
    alleRawDaten = daten;

    // Live: letzte 10 Werte (ca. 5 Minuten bei 30s-Takt)
    const liveLabels = alleLabels.map(l => l.substring(11));
    const liveDaten = alleDaten;

    if (liveChart) liveChart.destroy();
    liveChart = new Chart(document.getElementById('laermpegel-live').getContext('2d'), {
        type: 'line',
        data: {
            labels: liveLabels,
            datasets: [
                {
                    label: 'Lärmpegel (dB)',
                    data: liveDaten,
                    borderColor: 'blue',
                    borderWidth: 1.5,
                    backgroundColor: 'rgba(0,0,255,0.08)',
                    fill: true,
                    tension: 0.1,
                    pointRadius: 2,
                    pointHoverRadius: 4
                },
                {
                    label: 'WHO Empfehlung (55 dB)',
                    data: genGrenzwertArray(55, liveLabels.length),
                    borderColor: 'green',
                    borderDash: [4,4],
                    pointRadius: 0,
                    borderWidth: 1,
                    fill: false
                },
                {
                    label: 'WHO kritisch (65 dB)',
                    data: genGrenzwertArray(65, liveLabels.length),
                    borderColor: 'orange',
                    borderDash: [4,4],
                    pointRadius: 0,
                    borderWidth: 1,
                    fill: false
                },
                {
                    label: 'WHO gesundheitsschädlich (70 dB)',
                    data: genGrenzwertArray(70, liveLabels.length),
                    borderColor: 'red',
                    borderDash: [4,4],
                    pointRadius: 0,
                    borderWidth: 1,
                    fill: false
                }
            ]
        },
        options: {
            plugins: {
                legend: { position: 'bottom' },
                tooltip: { cornerRadius: 6 }
            },
            scales: {
                y: { min: 40, max: 100, title: {display:true, text:'dB'} }
            }
        },
        plugins: [backgroundRangesPlugin]
    });

    // Standard: Letzte 10 Minuten
    updateHistoricChartPreset(10);
}

function renderHistoricChart(labels, daten) {
    if (historicChart) historicChart.destroy();
    historicChart = new Chart(document.getElementById('laermpegel-historic').getContext('2d'), {
        type: 'line',
        data: {
            labels,
            datasets: [
                {
                    label: 'Lärmpegel (dB)',
                    data: daten,
                    borderColor: 'blue',
                    borderWidth: 1.5,
                    backgroundColor: 'rgba(0,0,255,0.08)',
                    fill: true,
                    tension: 0.1,
                    pointRadius: 2,
                    pointHoverRadius: 4
                },
                {
                    label: 'WHO Empfehlung (55 dB)',
                    data: genGrenzwertArray(55, labels.length),
                    borderColor: 'green',
                    borderDash: [4,4],
                    pointRadius: 0,
                    borderWidth: 1,
                    fill: false
                },
                {
                    label: 'WHO kritisch (65 dB)',
                    data: genGrenzwertArray(65, labels.length),
                    borderColor: 'orange',
                    borderDash: [4,4],
                    pointRadius: 0,
                    borderWidth: 1,
                    fill: false
                },
                {
                    label: 'WHO gesundheitsschädlich (70 dB)',
                    data: genGrenzwertArray(70, labels.length),
                    borderColor: 'red',
                    borderDash: [4,4],
                    pointRadius: 0,
                    borderWidth: 1,
                    fill: false
                }
            ]
        },
        options: {
            plugins: {
                legend: { position: 'bottom' },
                tooltip: { cornerRadius: 6 }
            },
            scales: {
                y: { min: 40, max: 100, title: {display:true, text:'dB'} }
            }
        },
        plugins: [backgroundRangesPlugin]
    });
}

document.getElementById('von').addEventListener('change', () => {/* leer, keine auto-update */});
document.getElementById('bis').addEventListener('change', () => {/* leer, keine auto-update */});

// Beim Laden initialisieren
ladePegelDaten();
</script>
</body>
</html>
