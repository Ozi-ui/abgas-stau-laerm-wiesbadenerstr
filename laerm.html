<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Lärmpegel-Auswertung</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #1854a3;
            --primary-dark: #133d7a;
            --secondary-color: #28a745;
            --accent-color: #ff6b35;
            --text-dark: #2c3e50;
            --text-light: #6c757d;
            --background-light: #f8f9fa;
            --white: #ffffff;
            --shadow: 0 10px 30px rgba(0,0,0,0.1);
            --shadow-hover: 0 20px 40px rgba(0,0,0,0.15);
            --border-radius: 12px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: var(--text-dark);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            display: flex;
            min-height: 100vh;
            max-width: 1400px;
            margin: 0 auto;
            background: var(--white);
            box-shadow: var(--shadow);
            border-radius: var(--border-radius);
            overflow: hidden;
        }

        /* Navigation */
        nav {
            width: 320px;
            background: linear-gradient(180deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            color: var(--white);
            display: flex;
            flex-direction: column;
            padding: 2rem 0;
            position: sticky;
            top: 0;
            height: 100vh;
            overflow-y: auto;
        }

        nav h1 {
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0 0 3rem 0;
            padding: 0 2rem;
            line-height: 1.3;
            text-align: center;
            position: relative;
        }

        nav h1::after {
            content: '';
            position: absolute;
            bottom: -1rem;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 3px;
            background: var(--accent-color);
            border-radius: 2px;
        }

        nav ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        nav li {
            margin-bottom: 0.5rem;
        }

        nav a {
            color: var(--white);
            text-decoration: none;
            display: flex;
            align-items: center;
            padding: 1rem 2rem;
            font-size: 1rem;
            font-weight: 500;
            transition: var(--transition);
            position: relative;
            opacity: 0.8;
        }

        nav a:hover,
        nav a.active {
            background: rgba(255, 255, 255, 0.1);
            opacity: 1;
            transform: translateX(5px);
        }

        nav a::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 4px;
            background: var(--accent-color);
            transform: scaleY(0);
            transition: var(--transition);
        }

        nav a.active::before,
        nav a:hover::before {
            transform: scaleY(1);
        }

        /* Main Content */
        .main {
            flex: 1;
            padding: 3rem 4rem;
            background: var(--white);
            overflow-y: auto;
        }

        .main h1 { /* Adjusted for main content H1 */
            font-size: 2.2rem;
            color: var(--primary-color);
            margin-bottom: 1.5rem;
            font-weight: 700;
        }

        .main h2 { /* Adjusted for main content H2 */
            font-size: 1.8rem;
            color: var(--primary-color);
            margin-top: 2.5rem;
            margin-bottom: 1rem;
            font-weight: 600;
        }

        .main p { /* Adjusted for main content paragraphs */
            color: var(--text-dark);
            margin-bottom: 1em;
        }

        .chart-block {
            margin-bottom: 3.5rem; /* Increased spacing between chart blocks */
            background: var(--background-light);
            border-radius: var(--border-radius);
            padding: 2.5rem; /* Consistent padding with other sections */
            box-shadow: 0 4px 20px rgba(0,0,0,0.05); /* Lighter shadow for charts */
            border: 1px solid rgba(0,0,0,0.03);
        }

        .input-row {
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px; /* Spacing for elements in input row */
        }

        .input-row label {
            font-weight: 500;
            color: var(--text-dark);
        }

        .input-row select,
        .input-row input[type="datetime-local"],
        .input-row button {
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid #ccc;
            font-size: 1em;
            color: var(--text-dark);
            background-color: var(--white);
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .input-row select:focus,
        .input-row input[type="datetime-local"]:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(24, 84, 163, 0.2);
            outline: none;
        }

        .input-row button {
            background: var(--primary-color);
            color: var(--white);
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.2s, transform 0.2s;
        }

        .input-row button:hover {
            background-color: var(--primary-dark);
            transform: translateY(-1px);
        }

        canvas {
            width: 100% !important;
            max-width: 1100px;
            height: 560px !important;
            min-height: 320px;
            border-radius: var(--border-radius); /* Consistent border-radius */
            background: var(--white); /* Changed to white for consistency with cards */
            box-shadow: 0 2px 8px #dde2ee; /* Lighter shadow */
            display: block;
            margin: 2rem auto 0 auto; /* Centered with top margin */
            border: 1px solid #f0f0f0; /* Subtle border for definition */
        }

        /* Responsive adjustments */
        @media (max-width: 1024px) {
            .container {
                flex-direction: column;
                margin: 1rem;
                border-radius: var(--border-radius);
            }

            nav {
                width: 100%;
                height: auto;
                position: static;
                padding: 1.5rem 0;
            }

            nav ul {
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
                gap: 0.5rem;
            }

            nav li {
                margin: 0;
            }

            nav a {
                padding: 0.75rem 1rem;
                border-radius: var(--border-radius);
                background: rgba(255,255,255,0.1);
                margin: 0.25rem;
            }

            .main {
                padding: 2rem 1.5rem;
            }

            .main h1 {
                font-size: 1.8rem;
            }

            .main h2 {
                font-size: 1.5rem;
            }

            .input-row {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }
            .input-row label {
                margin-bottom: 5px; /* Add some space below labels in column layout */
            }
        }

        @media (max-width: 768px) {
            .main h1 {
                font-size: 1.6rem;
            }

            .main h2 {
                font-size: 1.3rem;
            }

            .main {
                padding: 1.5rem 1rem;
            }

            canvas { height: 280px !important; min-height: 200px; } /* Adjust canvas height for smaller screens */
        }
    </style>
</head>
<body>
<div class="container">
    <nav>
        <h1>Nachbarschaft<br>Lärmschutz<br>Königstein/Schneidhain</h1>
        <ul>
            <li><a href="index.html">Startseite</a></li>
            <li><a href="laerm.html" class="active">Lärmmessung</a></li>
            <li><a href="fahrzeuge.html">Fahrzeugaufkommen</a></li>
            <li><a href="abgas.html">Abgase</a></li>
            <li><a href="kontakt.html">Kontakt</a></li>
        </ul>
    </nav>

    <div class="main">
        <h1>Lärmpegel-Auswertung</h1>

        <div class="chart-block">
            <h2>Lärmpegel (Live, alle 5 Minuten aktualisiert)</h2>
            <p>WHO-Grenzwerte: **55 dB** (Empfehlung), **65 dB** (kritisch), **70 dB** (gesundheitsschädlich)</p>
            <canvas id="laermpegel-live"></canvas>
        </div>

        <div class="chart-block">
            <h2>Historische Lärmpegel-Auswertung</h2>
            <div class="input-row">
                <label for="zeitraum-select">Zeitraum:</label>
                <select id="zeitraum-select" onchange="setZeitraumSelect()">
                    <option value="10">letzte 10 Minuten</option>
                    <option value="30">letzte 30 Minuten</option>
                    <option value="60">letzte 1 Stunde</option>
                    <option value="360">letzte 6 Stunden</option>
                    <option value="720">letzte 12 Stunden</option>
                    <option value="1440">letzte 24 Stunden</option>
                </select>
                <span>oder Zeitraum:</span>
                <label for="von">von:</label>
                <input type="datetime-local" id="von">
                <label for="bis">bis:</label>
                <input type="datetime-local" id="bis">
                <button onclick="zeitraumVonBis()">Anwenden</button>
            </div>
            <canvas id="laermpegel-historic"></canvas>
        </div>
    </div>
</div>

<script>
// Chart.js Plugin für farbige Schwellenbereiche
const backgroundRangesPlugin = {
    id: 'backgroundRanges',
    beforeDatasetsDraw: (chart) => {
        const { ctx, chartArea, scales } = chart;
        if (!chartArea) return;
        const ranges = [
            [40, 55, 'green', 0.07],
            [55, 65, 'yellow', 0.07],
            [65, 70, 'orange', 0.07],
            [70, 100, 'red', 0.06]
        ];
        ranges.forEach(([yMin, yMax, color, alpha]) => {
            ctx.save();
            ctx.globalAlpha = alpha;
            ctx.fillStyle = color;
            const y0 = scales.y.getPixelForValue(yMax);
            const y1 = scales.y.getPixelForValue(yMin);
            ctx.fillRect(chartArea.left, y0, chartArea.right - chartArea.left, y1 - y0);
            ctx.restore();
        });
    }
};

let alleLabels = [];
let alleDaten = [];
let alleRawLabels = [];
let alleRawDaten = [];

async function fetchPegelDaten() {
    const response = await fetch('Daten/pegel.txt'); // Pfad zu deiner Daten-Textdatei
    const text = await response.text();
    const lines = text.trim().split('\n');
    const labels = [];
    const daten = [];
    lines.forEach(line => {
        const match = line.match(/^(\d{4}-\d{2}-\d{2} \d{2}:\d{2}):\d{2} - (?:Maximaler|Aktueller) Pegel: ([0-9.]+) dB$/);
        if (match) {
            labels.push(match[1]);
            daten.push(parseFloat(match[2]));
        }
    });
    return {labels, daten};
}

function genGrenzwertArray(wert, len) {
    return Array(len).fill(wert);
}

let liveChart;
let historicChart;

function setZeitraumSelect() {
    const minuten = parseInt(document.getElementById('zeitraum-select').value, 10);
    document.getElementById('von').value = '';
    document.getElementById('bis').value = '';
    updateHistoricChartPreset(minuten);
}

function updateHistoricChartPreset(minuten) {
    const now = new Date();
    const msBack = minuten * 60 * 1000;
    const timeBack = new Date(now.getTime() - msBack);
    const filteredIdx = alleRawLabels
        .map((label, idx) => ({label, idx}))
        .filter(obj => {
            const d = new Date(obj.label.replace(' ', 'T'));
            return d >= timeBack;
        })
        .map(obj => obj.idx);

    let labels = [];
    let daten = [];
    if (filteredIdx.length > 0) {
        labels = filteredIdx.map(i => alleRawLabels[i].substring(11));
        daten = filteredIdx.map(i => alleRawDaten[i]);
    }
    renderHistoricChart(labels, daten);
}

function zeitraumVonBis() {
    const von = document.getElementById('von').value;
    const bis = document.getElementById('bis').value;
    if (!von || !bis) {
        alert("Bitte 'von' und 'bis' Datum/Zeit wählen.");
        return;
    }
    const vonDate = new Date(von);
    const bisDate = new Date(bis);

    const filteredIdx = alleRawLabels
        .map((label, idx) => ({label, idx}))
        .filter(obj => {
            const d = new Date(obj.label.replace(' ', 'T'));
            return d >= vonDate && d <= bisDate;
        })
        .map(obj => obj.idx);

    let labels = [];
    let daten = [];
    if (filteredIdx.length > 0) {
        labels = filteredIdx.map(i => alleRawLabels[i].substring(11));
        daten = filteredIdx.map(i => alleRawDaten[i]);
    }
    renderHistoricChart(labels, daten);
}

async function ladePegelDaten() {
    const { labels, daten } = await fetchPegelDaten();
    alleLabels = labels.slice(-10); // Für Live-Chart: letzte 10
    alleDaten = daten.slice(-10);
    alleRawLabels = labels;
    alleRawDaten = daten;

    // Live: letzte 10 Werte
    const liveLabels = alleLabels.map(l => l.substring(11));
    const liveDaten = alleDaten;

    if (liveChart) liveChart.destroy();
    liveChart = new Chart(document.getElementById('laermpegel-live').getContext('2d'), {
        type: 'line',
        data: {
            labels: liveLabels,
            datasets: [
                {
                    label: 'Lärmpegel (dB)',
                    data: liveDaten,
                    borderColor: '#1a74d6',
                    borderWidth: 1,
                    backgroundColor: 'rgba(26,116,214,0.08)',
                    fill: true,
                    tension: 0.3,
                    pointRadius: 0,
                    pointHoverRadius: 0,
                    z: 0
                },
                {
                    label: 'WHO Empfehlung (55 dB)',
                    data: genGrenzwertArray(55, liveLabels.length),
                    borderColor: '#32CD32',
                    borderWidth: 2,
                    pointRadius: 0,
                    fill: false,
                    z: 1
                },
                {
                    label: 'WHO kritisch (65 dB)',
                    data: genGrenzwertArray(65, liveLabels.length),
                    borderColor: '#FFD700',
                    borderWidth: 2,
                    pointRadius: 0,
                    fill: false,
                    z: 1
                },
                {
                    label: 'WHO gesundheitsschädlich (70 dB)',
                    data: genGrenzwertArray(70, liveLabels.length),
                    borderColor: '#FF4500',
                    borderWidth: 2,
                    pointRadius: 0,
                    fill: false,
                    z: 1
                }
            ]
        },
        options: {
            plugins: {
                legend: { position: 'top' },
                tooltip: { cornerRadius: 8, backgroundColor: '#fff', titleColor: '#333', bodyColor: '#333' }
            },
            scales: {
                x: {
                    grid: { color: '#eee' },
                    ticks: { color: '#555', font: { size: 13 }, maxTicksLimit: 8 }
                },
                y: {
                    min: 20,
                    max: 100,
                    title: {display:true, text:'dB'},
                    grid: { color: '#eee' },
                    ticks: { color: '#555', font: { size: 13 }, stepSize: 5 }
                }
            }
        },
        plugins: [backgroundRangesPlugin]
    });

    // Standard: Letzte 10 Minuten
    updateHistoricChartPreset(10);
}

function renderHistoricChart(labels, daten) {
    if (historicChart) historicChart.destroy();
    historicChart = new Chart(document.getElementById('laermpegel-historic').getContext('2d'), {
        type: 'line',
        data: {
            labels,
            datasets: [
                {
                    label: 'Lärmpegel (dB)',
                    data: daten,
                    borderColor: '#1a74d6',
                    borderWidth: 1,
                    backgroundColor: 'rgba(26,116,214,0.08)',
                    fill: true,
                    tension: 0.3,
                    pointRadius: 0,
                    pointHoverRadius: 0,
                    z: 0
                },
                {
                    label: 'WHO Empfehlung (55 dB)',
                    data: genGrenzwertArray(55, labels.length),
                    borderColor: '#32CD32',
                    borderWidth: 2,
                    pointRadius: 0,
                    fill: false,
                    z: 1
                },
                {
                    label: 'WHO kritisch (65 dB)',
                    data: genGrenzwertArray(65, labels.length),
                    borderColor: '#FFD700',
                    borderWidth: 2,
                    pointRadius: 0,
                    fill: false,
                    z: 1
                },
                {
                    label: 'WHO gesundheitsschädlich (70 dB)',
                    data: genGrenzwertArray(70, labels.length),
                    borderColor: '#FF4500',
                    borderWidth: 2,
                    pointRadius: 0,
                    fill: false,
                    z: 1
                }
            ]
        },
        options: {
            plugins: {
                legend: { position: 'top' },
                tooltip: { cornerRadius: 8, backgroundColor: '#fff', titleColor: '#333', bodyColor: '#333' }
            },
            scales: {
                x: {
                    grid: { color: '#eee' },
                    ticks: { color: '#555', font: { size: 13 }, maxTicksLimit: 10 }
                },
                y: {
                    min: 20,
                    max: 100,
                    title: {display:true, text:'dB'},
                    grid: { color: '#eee' },
                    ticks: { color: '#555', font: { size: 13 }, stepSize: 5 }
                }
            }
        },
        plugins: [backgroundRangesPlugin]
    });
}

// Event-Listener (keine auto-update) - Diese Zeilen waren bereits korrekt und müssen nicht geändert werden.
document.getElementById('von').addEventListener('change', () => {});
document.getElementById('bis').addEventListener('change', () => {});

ladePegelDaten();
</script>
</body>
</html>
