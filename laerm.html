<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Lärmpegel-Auswertung</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.0.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.2.0"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f7f7f7;
            margin: 40px;
        }
        h2 {
            margin-top: 40px;
        }
        #container {
            max-width: 1000px;
            margin: auto;
            background: #fff;
            padding: 36px;
            border-radius: 10px;
            box-shadow: 0 0 16px #c2c2c2;
        }
        .chart-block {
            margin-bottom: 55px;
        }
        .input-row {
            margin-bottom: 18px;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
        }
        .nav {
            margin-bottom: 30px;
            background: #224e7a;
            color: #fff;
            padding: 14px 24px;
            border-radius: 6px;
        }
        .nav a {
            color: #fff;
            margin-right: 30px;
            text-decoration: none;
            font-weight: bold;
        }
        .nav a:hover {
            text-decoration: underline;
        }
        .input-row label {
            margin-right: 8px;
        }
        @media (max-width: 800px) {
            #container {
                padding: 3vw;
            }
            .input-row {
                flex-direction: column;
                align-items: stretch;
            }
        }
        canvas {
            width: 100% !important;
            height: auto !important;
            max-width: 100%;
            min-height: 320px;
            border-radius: 8px;
            background: #fafcff;
            box-shadow: 0 2px 8px #dde2ee;
        }
    </style>
</head>
<body>
<div id="container">
    <div class="nav">
        <a href="index.html">Start</a>
        <a href="laerm.html">Lärmpegel</a>
        <a href="abgas.html">Abgas</a>
        <a href="stau.html">Stau</a>
    </div>
    <h1>Lärmpegel Monitoring</h1>
    <div class="chart-block">
        <h2>Lärmpegel (Live, alle 5 Minuten aktualisiert)</h2>
        <p>WHO-Grenzwerte: 55 dB (Empfehlung), 65 dB (kritisch), 70 dB (gesundheitsschädlich)</p>
        <canvas id="laermpegel-live" height="180" width="1000"></canvas>
    </div>
    <div class="chart-block">
        <h2>Historische Lärmpegel-Auswertung</h2>
        <div class="input-row">
            <label for="zeitraum-select" style="margin-right:8px;">Zeitraum:</label>
            <select id="zeitraum-select" onchange="setZeitraumSelect()">
                <option value="10">Letzte 10 Minuten</option>
                <option value="30">Letzte 30 Minuten</option>
                <option value="60">Letzte 1 Stunde</option>
                <option value="360">Letzte 6 Stunden</option>
                <option value="720">Letzte 12 Stunden</option>
                <option value="1440">Letzte 24 Stunden</option>
                <option value="custom">Benutzerdefiniert</option>
            </select>
            <div id="custom-zeitraum" style="display: none;">
                <label for="von" style="margin-right:8px; margin-left:24px;">Von:</label>
                <input type="datetime-local" id="von" style="margin-right:8px;">
                <label for="bis" style="margin-right:8px;">Bis:</label>
                <input type="datetime-local" id="bis" style="margin-right:8px;">
                <button onclick="zeitraumVonBis()">Anwenden</button>
            </div>
        </div>
        <canvas id="laermpegel-historic" height="320" width="1000"></canvas>
    </div>
</div>
<script>
// Chart.js Plugin für farbige Schwellenbereiche
const backgroundRangesPlugin = {
    id: 'backgroundRanges',
    beforeDatasetsDraw: (chart) => {
        const { ctx, chartArea, scales } = chart;
        if (!chartArea) return;
        const ranges = [
            [40, 55, 'rgba(27, 193, 59, 0.1)', 0.07],
            [55, 65, 'rgba(232, 161, 0, 0.1)', 0.07],
            [65, 70, 'rgba(225, 60, 60, 0.1)', 0.07],
            [70, 100, 'rgba(225, 60, 60, 0.2)', 0.06]
        ];
        ranges.forEach(([yMin, yMax, color, alpha]) => {
            ctx.save();
            ctx.globalAlpha = alpha;
            ctx.fillStyle = color;
            const y0 = scales.y.getPixelForValue(yMax);
            const y1 = scales.y.getPixelForValue(yMin);
            ctx.fillRect(chartArea.left, y0, chartArea.right - chartArea.left, y1 - y0);
            ctx.restore();
        });
    }
};

let alleLabels = [];
let alleDaten = [];
let alleRawLabels = [];
let alleRawDaten = [];

async function fetchPegelDaten() {
    // Simulierte Daten, da keine echte Datenquelle vorhanden ist
    const labels = [];
    const daten = [];
    const now = new Date();
    for (let i = 0; i < 100; i++) {
        const time = new Date(now.getTime() - (100 - i) * 30000);
        labels.push(time.toISOString().replace('T', ' ').substring(0, 16));
        daten.push(50 + Math.random() * 30);
    }
    return { labels, daten };
}

function genGrenzwertArray(wert, len) {
    return Array(len).fill(wert);
}

let liveChart;
let historicChart;

function setZeitraumSelect() {
    const value = document.getElementById('zeitraum-select').value;
    const customZeitraum = document.getElementById('custom-zeitraum');
    if (value === 'custom') {
        customZeitraum.style.display = 'flex';
    } else {
        customZeitraum.style.display = 'none';
        updateHistoricChartPreset(parseInt(value, 10));
    }
}

function updateHistoricChartPreset(minuten) {
    const now = new Date();
    const msBack = minuten * 60 * 1000;
    const timeBack = new Date(now.getTime() - msBack);

    const filteredIdx = alleRawLabels
        .map((label, idx) => ({ label, idx }))
        .filter(obj => {
            const d = new Date(obj.label.replace(' ', 'T'));
            return d >= timeBack;
        })
        .map(obj => obj.idx);

    let labels = [];
    let daten = [];
    if (filteredIdx.length > 0) {
        labels = filteredIdx.map(i => alleRawLabels[i]);
        daten = filteredIdx.map(i => alleRawDaten[i]);
    }

    renderHistoricChart(labels, daten);
}

function zeitraumVonBis() {
    const von = document.getElementById('von').value;
    const bis = document.getElementById('bis').value;

    if (!von || !bis) {
        alert("Bitte 'von' und 'bis' Datum/Zeit wählen.");
        return;
    }

    const vonDate = new Date(von);
    const bisDate = new Date(bis);

    const filteredIdx = alleRawLabels
        .map((label, idx) => ({ label, idx }))
        .filter(obj => {
            const d = new Date(obj.label.replace(' ', 'T'));
            return d >= vonDate && d <= bisDate;
        })
        .map(obj => obj.idx);

    let labels = [];
    let daten = [];
    if (filteredIdx.length > 0) {
        labels = filteredIdx.map(i => alleRawLabels[i]);
        daten = filteredIdx.map(i => alleRawDaten[i]);
    }

    renderHistoricChart(labels, daten);
}

async function ladePegelDaten() {
    const { labels, daten } = await fetchPegelDaten();
    alleLabels = labels.slice(-10);
    alleDaten = daten.slice(-10);
    alleRawLabels = labels;
    alleRawDaten = daten;

    // Live: letzte 10 Werte
    const liveLabels = alleLabels.map(l => l.substring(11));
    const liveDaten = alleDaten;

    if (liveChart) liveChart.destroy();
    liveChart = new Chart(document.getElementById('laermpegel-live').getContext('2d'), {
        type: 'line',
        data: {
            labels: liveLabels,
            datasets: [
                {
                    label: 'Lärmpegel (dB)',
                    data: liveDaten,
                    borderColor: '#1a74d6',
                    borderWidth: 1,
                    backgroundColor: 'rgba(26,116,214,0.08)',
                    fill: true,
                    tension: 0.3,
                    pointRadius: 1.5,
                    pointHoverRadius: 3,
                    pointBackgroundColor: '#1a74d6'
                },
                {
                    label: 'WHO Empfehlung (55 dB)',
                    data: genGrenzwertArray(55, liveLabels.length),
                    borderColor: '#1bc13b',
                    borderDash: [4, 4],
                    pointRadius: 0,
                    borderWidth: 1,
                    fill: false
                },
                {
                    label: 'WHO kritisch (65 dB)',
                    data: genGrenzwertArray(65, liveLabels.length),
                    borderColor: '#e8a100',
                    borderDash: [4, 4],
                    pointRadius: 0,
                    borderWidth: 1,
                    fill: false
                },
                {
                    label: 'WHO gesundheitsschädlich (70 dB)',
                    data: genGrenzwertArray(70, liveLabels.length),
                    borderColor: '#e13c3c',
                    borderDash: [4, 4],
                    pointRadius: 0,
                    borderWidth: 1,
                    fill: false
                }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'top' },
                tooltip: {
                    cornerRadius: 8,
                    backgroundColor: '#fff',
                    titleColor: '#333',
                    bodyColor: '#333',
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            if (context.parsed.y !== null) {
                                label += context.parsed.y.toFixed(2) + ' dB';
                            }
                            return label;
                        }
                    }
                }
            },
            scales: {
                x: {
                    grid: { color: '#eee' },
                    ticks: { color: '#555' }
                },
                y: {
                    min: 40,
                    max: 100,
                    title: { display: true, text: 'dB' },
                    grid: { color: '#eee' },
                    ticks: { color: '#555' }
                }
            }
        },
        plugins: [backgroundRangesPlugin]
    });

    // Standard: Letzte 10 Minuten
    updateHistoricChartPreset(10);
}

function renderHistoricChart(labels, daten) {
    if (historicChart) historicChart.destroy();
    historicChart = new Chart(document.getElementById('laermpegel-historic').getContext('2d'), {
        type: 'line',
        data: {
            labels,
            datasets: [
                {
                    label: 'Lärmpegel (dB)',
                    data: daten,
                    borderColor: '#1a74d6',
                    borderWidth: 1,
                    backgroundColor: 'rgba(26,116,214,0.08)',
                    fill: true,
                    tension: 0.3,
                    pointRadius: 1.5,
                    pointHoverRadius: 3,
                    pointBackgroundColor: '#1a74d6'
                },
                {
                    label: 'WHO Empfehlung (55 dB)',
                    data: genGrenzwertArray(55, labels.length),
                    borderColor: '#1bc13b',
                    borderDash: [4, 4],
                    pointRadius: 0,
                    borderWidth: 1,
                    fill: false
                },
                {
                    label: 'WHO kritisch (65 dB)',
                    data: genGrenzwertArray(65, labels.length),
                    borderColor: '#e8a100',
                    borderDash: [4, 4],
                    pointRadius: 0,
                    borderWidth: 1,
                    fill: false
                },
                {
                    label: 'WHO gesundheitsschädlich (70 dB)',
                    data: genGrenzwertArray(70, labels.length),
                    borderColor: '#e13c3c',
                    borderDash: [4, 4],
                    pointRadius: 0,
                    borderWidth: 1,
                    fill: false
                }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'top' },
                tooltip: {
                    cornerRadius: 8,
                    backgroundColor: '#fff',
                    titleColor: '#333',
                    bodyColor: '#333',
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            if (context.parsed.y !== null) {
                                label += context.parsed.y.toFixed(2) + ' dB';
                            }
                            return label;
                        }
                    }
                }
            },
            scales: {
                x: {
                    grid: { color: '#eee' },
                    ticks: { color: '#555' }
                },
                y: {
                    min: 40,
                    max: 100,
                    title: { display: true, text: 'dB' },
                    grid: { color: '#eee' },
                    ticks: { color: '#555' }
                }
            }
        },
        plugins: [backgroundRangesPlugin]
    });
}

document.getElementById('zeitraum-select').addEventListener('change', function() {
    const customZeitraum = document.getElementById('custom-zeitraum');
    if (this.value === 'custom') {
        customZeitraum.style.display = 'flex';
    } else {
        customZeitraum.style.display = 'none';
    }
});

ladePegelDaten();
</script>
</body>
</html>
