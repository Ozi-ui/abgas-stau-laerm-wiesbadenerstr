<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Fahrzeugaufkommen – Wiesbadener Straße</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    body { margin: 0; font-family: 'Segoe UI', Arial, sans-serif; background: #f4f6fa; color: #222; }
    .container { display: flex; min-height: 100vh; }
    nav { width: 270px; background: #1854a3; color: #fff; display: flex; flex-direction: column; padding-top: 32px; box-shadow: 2px 0 12px #0002; position: sticky; top: 0; min-height: 100vh; z-index: 10;}
    nav h1 { font-size: 1.3em; font-weight: 700; margin: 0 0 2em 0; padding: 0 30px; line-height: 1.2; color: #fff;}
    nav ul { list-style: none; padding: 0; margin: 0 0 2em 0;}
    nav li { margin-bottom: 0.3em;}
    nav a { color: #fff; text-decoration: none; display: block; padding: 14px 36px; font-size: 1.07em; border-left: 4px solid transparent; transition: background 0.19s, border 0.19s; letter-spacing: 0.01em;}
    nav a.active, nav a:hover { background: #2365c9; border-left: 4px solid #fff;}
    nav .nav-sub { margin-left: 1em; margin-bottom: 0.2em; font-size: 0.98em;}
    .main { flex: 1; padding: 44px 5vw 44px 5vw; max-width: 900px; margin: 0 auto; background: #fff; box-shadow: 0 4px 24px #1854a318; border-radius: 0 0 22px 22px;}
    .blue-head { background: linear-gradient(90deg, #2176ff 85%, #143e74 100%); color: #fff; font-size: 2.0em; font-weight: 600; padding: 30px 36px 28px 36px; margin: -44px -5vw 36px -5vw; border-radius: 0 0 18px 0; box-shadow: 2px 6px 24px #1854a330; letter-spacing: 0.02em; line-height: 1.13;}
    .chart-section { margin: 28px 0 48px 0; }
    .chart-container { background: #f8fbff; border-radius: 10px; padding: 22px 20px; margin-bottom: 23px; box-shadow: 0 2px 18px #0001; max-width: 700px; }
    .chart-controls { margin-bottom: 10px; font-size: 0.98em;}
    .chart-controls label, .chart-controls select, .chart-controls input, .chart-controls button { margin-right: 10px; margin-bottom: 4px;}
    @media (max-width: 900px) {
      .container { flex-direction: column; }
      nav { width: 100vw; min-height: unset; position: static; box-shadow: none; }
      .main { padding: 20px 2vw; border-radius: 0 0 10px 10px;}
      .blue-head { font-size: 1.2em; padding: 16px 10px; margin: -20px -2vw 24px -2vw;}
    }
  </style>
</head>
<body>
<div class="container">
  <nav>
    <h1>Nachbarschaft<br>Lärmschutz Wiesbadener Straße</h1>
    <ul>
      <li>
        <a href="laerm.html">Lärmmessung</a>
        <div class="nav-sub">
          <div>• Aktuelle Lärmpegel</div>
          <div>• Historische Lärmpegel</div>
        </div>
      </li>
      <li>
        <a href="fahrzeuge.html" class="active">Fahrzeugaufkommen</a>
        <div class="nav-sub">
          <div>• Aktuelles Fahrzeugaufkommen (1h)</div>
          <div>• Historisches Fahrzeugaufkommen</div>
          <div>• Balkendiagramm Fahrzeugaufkommen</div>
        </div>
      </li>
      <li>
        <a href="index.html">Startseite</a>
      </li>
    </ul>
  </nav>
  <div class="main">
    <div class="blue-head">
      Fahrzeugaufkommen
    </div>
    <section class="chart-section" id="fahrzeuge">
      <div class="chart-container">
        <h4>Balkendiagramm Fahrzeugarten (letzte Stunde)</h4>
        <div id="vehicle-bar" style="height:300px;"></div>
      </div>
      <div class="chart-container">
        <h4>Historisches Fahrzeugaufkommen</h4>
        <div class="chart-controls">
          <label>Zeitraum:
            <select id="vehicle-historic-interval" onchange="drawVehicleHistoric()">
              <option value="10">Letzte 10 Minuten</option>
              <option value="20">Letzte 20 Minuten</option>
              <option value="30">Letzte 30 Minuten</option>
              <option value="60">Letzte 1 Stunde</option>
              <option value="720">Letzte 12 Stunden</option>
              <option value="1440" selected>Letzte 24 Stunden</option>
            </select>
          </label>
          <label>Von: <input type="datetime-local" id="vehicle-historic-from"></label>
          <label>Bis: <input type="datetime-local" id="vehicle-historic-to"></label>
          <button onclick="drawVehicleHistoricCustom()">Anzeigen</button>
        </div>
        <div id="vehicle-historic" style="height:300px;"></div>
      </div>
    </section>
  </div>
</div>
<script>
  async function loadVehicleData() {
    const res = await fetch('Daten/vehicle_counts.txt');
    const txt = await res.text();
    return txt.split('\n')
      .map(l => {
        const m = l.match(/^([\d\-]+),\s*([\d:]+),\s*(\w+)/);
        if(m) return {time: new Date(m[1] + 'T' + m[2]), type: m[3]};
        return null;
      })
      .filter(x => x);
  }
  // Aktuelles Fahrzeugaufkommen Balkendiagramm (letzte Stunde)
  async function drawVehicleBar() {
    const data = await loadVehicleData();
    const to = data.length > 0 ? data[data.length-1].time : new Date();
    const from = new Date(to.getTime() - 60*60000); // letzte Stunde
    const filtered = data.filter(d => d.time >= from && d.time <= to);
    const types = ['PKW', 'LKW', 'Motorrad'];
    const farben = [
      'rgba(54, 162, 235, 0.8)',
      'rgba(255, 99, 132, 0.8)',
      'rgba(255, 206, 86, 0.8)'
    ];
    const counts = types.map(type =>
      filtered.filter(d => d.type.toLowerCase().includes(type.toLowerCase())).length
    );
    const trace = {
      x: types,
      y: counts,
      type: 'bar',
      marker: {color: farben},
      text: counts.map(String),
      textposition: 'auto'
    };
    const layout = {
      xaxis: {title: 'Fahrzeugtyp'},
      yaxis: {title: 'Anzahl', rangemode:'tozero'},
      margin: {t:20}
    };
    Plotly.newPlot('vehicle-bar', [trace], layout, {responsive:true});
  }
  drawVehicleBar();

  // Verlauf (Historisch)
  async function drawVehicleHistoric() {
    const data = await loadVehicleData();
    const intervalMin = parseInt(document.getElementById('vehicle-historic-interval').value, 10);
    const to = data.length > 0 ? data[data.length-1].time : new Date();
    const from = new Date(to.getTime() - intervalMin*60*1000);
    plotVehicleHistoric(data, from, to);
  }
  async function drawVehicleHistoricCustom() {
    const data = await loadVehicleData();
    const fromVal = document.getElementById('vehicle-historic-from').value;
    const toVal = document.getElementById('vehicle-historic-to').value;
    if (!fromVal || !toVal) return;
    plotVehicleHistoric(data, new Date(fromVal), new Date(toVal));
  }
  function plotVehicleHistoric(data, from, to) {
    const filtered = data.filter(d => d.time >= from && d.time <= to);
    const types = ['PKW', 'LKW', 'Motorrad'];
    const farben = [
      'rgba(54, 162, 235, 0.8)',
      'rgba(255, 99, 132, 0.8)',
      'rgba(255, 206, 86, 0.8)'
    ];
    // Gruppiere nach 5-Minuten-Zeitfenster, oder 1h für große Zeiträume
    const interval = (to-from)/(60*60*1000) > 4 ? 60 : 5;
    const groups = {};
    filtered.forEach(d => {
      const t = new Date(d.time);
      t.setMinutes(Math.floor(t.getMinutes() / interval) * interval, 0, 0);
      const key = t.toISOString();
      if (!groups[key]) groups[key] = {PKW: 0, LKW: 0, Motorrad: 0, time: new Date(t)};
      if (types.includes(d.type)) groups[key][d.type]++;
    });
    const sorted = Object.values(groups).sort((a,b) => a.time-b.time);
    const traces = types.map((type,i) => ({
      x: sorted.map(g => g.time),
      y: sorted.map(g => g[type]),
      name: type,
      type: 'scatter',
      mode: 'lines+markers',
      line: {color: farben[i]}
    }));
    Plotly.newPlot('vehicle-historic', traces, {
      xaxis:{title:'Zeit'},
      yaxis:{title:'Anzahl', rangemode:'tozero'},
      margin:{t:20},
      legend: {orientation: "h"}
    }, {responsive:true});
  }
  drawVehicleHistoric();
</script>
</body>
</html>
