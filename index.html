<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Abgas, Stau & Lärm – Wiesbadener Straße Königstein/Schnaidhein</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: #eef3f8;
            margin: 0;
            padding: 0;
        }
        .sidebar {
            position: fixed;
            left: 0; top: 0; bottom: 0;
            width: 270px;
            background: #1854a3;
            color: white;
            padding-top: 32px;
            box-shadow: 2px 0 10px #0002;
            z-index: 100;
        }
        .sidebar h1 {
            font-size: 1.3em;
            margin: 0 0 2em 0;
            padding: 0 24px;
            color: #fff;
            letter-spacing: 0.06em;
        }
        .sidebar nav {
            display: flex;
            flex-direction: column;
            margin: 0 0 2em 0;
        }
        .sidebar nav a {
            color: white;
            text-decoration: none;
            padding: 14px 32px;
            font-size: 1.08em;
            border-left: 4px solid transparent;
            transition: background 0.18s, border 0.18s;
        }
        .sidebar nav a.active, .sidebar nav a:hover {
            background: #2365c9;
            border-left: 4px solid #fff;
        }
        .sidebar .contact {
            position: absolute; bottom: 30px; left: 0; right: 0;
            background: #143e74;
            padding: 18px 32px;
            border-top: 1px solid #ffffff22;
        }
        .sidebar .contact h2 {
            font-size: 1em; margin: 0 0 0.2em 0; color: #fff;
        }
        .sidebar .contact p { font-size: 0.98em; margin: 0; color: #e5eaff;}
        .main-content {
            margin-left: 270px;
            padding: 40px 6vw 32px 6vw;
            max-width: 1120px;
            min-height: 100vh;
        }
        .blue-bar {
            background: linear-gradient(90deg, #2176ff 80%, #143e74 100%);
            color: #fff;
            font-size: 2.1em;
            font-weight: 600;
            padding: 32px 36px;
            margin-bottom: 38px;
            border-radius: 0 18px 18px 0;
            box-shadow: 2px 6px 24px #1854a330;
            letter-spacing: 0.02em;
            line-height: 1.18;
        }
        h2 { color: #1854a3; margin-top: 1.8em;}
        .chart-container {
            background: #fff;
            padding: 24px 24px 16px 24px;
            margin-bottom: 40px;
            border-radius: 12px;
            box-shadow: 0 2px 18px #0001;
        }
        .controls label { margin-right: 1em; }
        .controls select, .controls input[type=datetime-local] {
            border: 1px solid #1854a3;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 1em;
            margin-right: 0.7em;
        }
        .controls button {
            background: #1854a3;
            color: #fff;
            border: none;
            border-radius: 4px;
            padding: 6px 16px;
            font-size: 1em;
            cursor: pointer;
            margin-top: 0.2em;
        }
        .controls button:hover {
            background: #2365c9;
        }
        @media (max-width: 900px) {
            .sidebar { width: 100vw; height: auto; position: static; }
            .main-content { margin: 0; padding: 20px 2vw;}
            .blue-bar { font-size: 1.4em; padding: 20px 20px; }
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <h1>Abgas, Stau & Lärm<br>Wiesbadener Straße<br>Königstein/Schnaidhein</h1>
        <nav>
            <a href="#dashboard" class="active">Dashboard</a>
            <a href="#laerm">Lärmmessung</a>
            <a href="#verkehr">Verkehr</a>
            <a href="#kontakt">Kontakt / Impressum</a>
        </nav>
        <div class="contact" id="kontakt">
            <h2>Kontakt &amp; Impressum</h2>
            <p>
                Diese Seite wird betrieben von:<br>
                <strong>[Dein Name/Verein]</strong><br>
                Wiesbadener Straße,<br>
                61462 Königstein im Taunus<br>
                <br>
                E-Mail: <a href="mailto:info@dein-projekt.de" style="color:#e2eaff;">info@dein-projekt.de</a>
            </p>
            <p style="font-size:0.9em; margin-top:1em;">
                © 2025 Abgas, Stau & Lärm Wiesbadener Straße<br>
                <a href="#impressum" style="color:#e2eaff;">Impressum</a>
            </p>
        </div>
    </div>
    <div class="main-content">
        <div class="blue-bar" id="dashboard">
            Aktuelle Analyse zu Abgas, Stau & Lärm der Wiesbadener Straße (B455) in Königstein/Schnaidhein
        </div>
        <div style="margin-bottom:32px; font-size:1.16em; color:#144;">
            Die Wiesbadener Straße ist ein Hotspot für Verkehr und Lärmbelastung in Königstein und Schnaidhein. Hier werden aktuelle und historische Messdaten zu Lärmpegel und Fahrzeugaufkommen visualisiert. Hohe Werte zeigen die Notwendigkeit für nachhaltige Verkehrsmaßnahmen – zum Schutz der Anwohner und Umwelt.
        </div>

        <!-- Lärmpegel Live Grafik -->
        <div class="chart-container" id="laerm">
            <h2>Lärmpegel (Live, alle 5 Minuten aktualisiert)</h2>
            <div id="laermpegel-live"></div>
            <small style="color:#555;">WHO-Grenzwerte: 55 dB (Empfehlung), 65 dB (kritisch), 70 dB (gesundheitsschädlich)</small>
        </div>

        <!-- Historische Lärmpegel Grafik mit Auswahl -->
        <div class="chart-container">
            <h2>Historische Lärmpegel-Auswertung</h2>
            <div class="controls">
                <label>Zeitraum: 
                    <select id="laerm-historic-select">
                        <option value="10">Letzte 10 Minuten</option>
                        <option value="30">Letzte 30 Minuten</option>
                        <option value="720">Letzte 12 Stunden</option>
                        <option value="1440">Letzte 24 Stunden</option>
                        <option value="custom">Benutzerdefiniert</option>
                    </select>
                </label>
                <span id="laerm-custom-controls" style="display:none">
                    Von: <input type="datetime-local" id="laerm-from">
                    Bis: <input type="datetime-local" id="laerm-to">
                </span>
                <button onclick="drawLaermHistoric()">Aktualisieren</button>
            </div>
            <div id="laermpegel-historic"></div>
        </div>

        <!-- Fahrzeuganzahl Balken Diagramm mit Auswahl -->
        <div class="chart-container" id="verkehr">
            <h2>Fahrzeugaufkommen (Balkendiagramm)</h2>
            <div class="controls">
                <label>Zeitraum: 
                    <select id="vehicle-historic-select">
                        <option value="10">Letzte 10 Minuten</option>
                        <option value="30">Letzte 30 Minuten</option>
                        <option value="720">Letzte 12 Stunden</option>
                        <option value="1440">Letzte 24 Stunden</option>
                        <option value="custom">Benutzerdefiniert</option>
                    </select>
                </label>
                <span id="vehicle-custom-controls" style="display:none">
                    Von: <input type="datetime-local" id="vehicle-from">
                    Bis: <input type="datetime-local" id="vehicle-to">
                </span>
                <button onclick="drawVehicleBar()">Aktualisieren</button>
            </div>
            <div id="vehicle-bar"></div>
        </div>

        <!-- Fahrzeugdichte Zeitreihe -->
        <div class="chart-container">
            <h2>Fahrzeugdichte (Zeitreihe)</h2>
            <div class="controls">
                <label>Zeitraum: 
                    <select id="vehicle-density-select">
                        <option value="10">Letzte 10 Minuten</option>
                        <option value="30">Letzte 30 Minuten</option>
                        <option value="720">Letzte 12 Stunden</option>
                        <option value="1440">Letzte 24 Stunden</option>
                        <option value="custom">Benutzerdefiniert</option>
                    </select>
                </label>
                <span id="vehicle-density-custom-controls" style="display:none">
                    Von: <input type="datetime-local" id="density-from">
                    Bis: <input type="datetime-local" id="density-to">
                </span>
                <button onclick="drawVehicleDensity()">Aktualisieren</button>
            </div>
            <div id="vehicle-density"></div>
        </div>
    </div>

    <script>
    // Helper: Parse pegel.txt
    async function loadLaermData() {
        const res = await fetch('Daten/pegel.txt');
        const txt = await res.text();
        return txt.split('\n')
            .map(l => {
                const m = l.match(/^([\d\-]+ [\d:]+) - Maximaler Pegel: ([\d.]+) dB$/);
                if(m) return {time: new Date(m[1]), value: parseFloat(m[2])};
                return null;
            })
            .filter(x => x);
    }

    // Helper: Parse vehicle_counts.txt
    async function loadVehicleData() {
        const res = await fetch('Daten/vehicle_counts.txt');
        const txt = await res.text();
        return txt.split('\n')
            .map(l => {
                const m = l.match(/^([\d\-]+),\s*([\d:]+),\s*(\w+)/);
                if(m) return {time: new Date(m[1] + 'T' + m[2]), type: m[3]};
                return null;
            })
            .filter(x => x);
    }

    // WHO Werte
    const WHO_LINES = [
        {y:55, color:'green', dash:'dot', label:'WHO Empfehlung 55 dB'},
        {y:65, color:'orange', dash:'dash', label:'Kritischer Wert 65 dB'},
        {y:70, color:'red', dash:'solid', label:'Gesundheitsschädlich 70 dB'}
    ];

    // Hintergrundfarben für dB-Bereiche
    const LAERM_BG_SHAPES = [
        // 0–55 dB: grün
        { type: 'rect', xref: 'paper', x0: 0, x1: 1, y0: 0, y1: 55,
          fillcolor: 'rgba(50,200,50,0.13)', line: {width:0} },
        // 55–65 dB: dunkelgelb
        { type: 'rect', xref: 'paper', x0: 0, x1: 1, y0: 55, y1: 65,
          fillcolor: 'rgba(180,140,0,0.14)', line: {width:0} },
        // 65–100 dB: dunkelrot
        { type: 'rect', xref: 'paper', x0: 0, x1: 1, y0: 65, y1: 100,
          fillcolor: 'rgba(180,30,30,0.13)', line: {width:0} }
    ];

    // Live Lärmpegel (letzte 5 Minuten)
    async function drawLaermLive() {
        const data = await loadLaermData();
        const tmax = data.length > 0 ? data[data.length-1].time : new Date();
        const tmin = new Date(tmax.getTime() - 5*60000);
        const live = data.filter(d => d.time >= tmin && d.time <= tmax);
        const trace = {
            x: live.map(d=>d.time),
            y: live.map(d=>d.value),
            type: 'scatter',
            mode: 'lines+markers',
            name: 'Lärmpegel',
            line: {color: '#2176ff'}
        };
        const layout = {
            title: 'Lärmpegel (letzte 5 Minuten)',
            xaxis: {title: 'Zeit'},
            yaxis: {title: 'dB', range: [30, 100]},
            shapes: [
                ...LAERM_BG_SHAPES,
                ...WHO_LINES.map(line => ({
                    type:'line', xref:'paper', x0:0, x1:1, y0:line.y, y1:line.y,
                    line:{color:line.color, dash:line.dash, width:2}
                }))
            ],
            annotations: WHO_LINES.map(line => ({
                xref:'paper', x:1.01, y:line.y, yref:'y', text:line.label, showarrow:false, font:{color:line.color}
            })),
            margin: {r:120}
        };
        Plotly.newPlot('laermpegel-live', [trace], layout);
    }
    setInterval(drawLaermLive, 5*60*1000); // alle 5 Minuten aktualisieren
    drawLaermLive();

    // Historische Lärmpegel
    async function drawLaermHistoric() {
        const data = await loadLaermData();
        let from, to;
        const sel = document.getElementById('laerm-historic-select').value;
        if(sel === 'custom') {
            from = new Date(document.getElementById('laerm-from').value);
            to = new Date(document.getElementById('laerm-to').value);
        } else {
            to = data.length > 0 ? data[data.length-1].time : new Date();
            from = new Date(to.getTime() - parseInt(sel)*60000);
        }
        const filtered = data.filter(d => d.time >= from && d.time <= to);

        const trace = {
            x: filtered.map(d=>d.time),
            y: filtered.map(d=>d.value),
            type: 'scatter',
            mode: 'lines',
            name: 'Lärmpegel',
            line: {color: '#2176ff'}
        };
        const layout = {
            title: `Lärmpegel Verlauf`,
            xaxis: {title: 'Zeit'},
            yaxis: {title: 'dB', range: [30, 100]},
            shapes: [
                ...LAERM_BG_SHAPES,
                ...WHO_LINES.map(line => ({
                    type:'line', xref:'paper', x0:0, x1:1, y0:line.y, y1:line.y,
                    line:{color:line.color, dash:line.dash, width:2}
                }))
            ],
            annotations: WHO_LINES.map(line => ({
                xref:'paper', x:1.01, y:line.y, yref:'y', text:line.label, showarrow:false, font:{color:line.color}
            })),
            margin: {r:120}
        };
        Plotly.newPlot('laermpegel-historic', [trace], layout);
    }
    document.getElementById('laerm-historic-select').addEventListener('change', function() {
        document.getElementById('laerm-custom-controls').style.display = this.value==='custom' ? '' : 'none';
    });
    drawLaermHistoric();

    // Fahrzeuganzahl Balken
    async function drawVehicleBar() {
        const data = await loadVehicleData();
        let from, to;
        const sel = document.getElementById('vehicle-historic-select').value;
        if(sel === 'custom') {
            from = new Date(document.getElementById('vehicle-from').value);
            to = new Date(document.getElementById('vehicle-to').value);
        } else {
            to = data.length > 0 ? data[data.length-1].time : new Date();
            from = new Date(to.getTime() - parseInt(sel)*60000);
        }
        const filtered = data.filter(d => d.time >= from && d.time <= to);
        const counts = {};
        filtered.forEach(d => { counts[d.type]=(counts[d.type]||0)+1; });
        const types = Object.keys(counts);
        const values = types.map(t=>counts[t]);

        const trace = {
            x: types,
            y: values,
            type: 'bar',
            marker: {color: '#2176ff'},
            text: values.map(String),
            textposition: 'auto'
        };
        const layout = {
            title: 'Fahrzeugaufkommen (Summe im Zeitraum)',
            xaxis: {title: 'Fahrzeugtyp'},
            yaxis: {title: 'Anzahl'},
            plot_bgcolor: '#f8fbff',
            paper_bgcolor: '#fff'
        };
        Plotly.newPlot('vehicle-bar', [trace], layout);
    }
    document.getElementById('vehicle-historic-select').addEventListener('change', function() {
        document.getElementById('vehicle-custom-controls').style.display = this.value==='custom' ? '' : 'none';
    });
    drawVehicleBar();

    // Fahrzeugdichte Zeitreihe
    async function drawVehicleDensity() {
        const data = await loadVehicleData();
        let from, to;
        const sel = document.getElementById('vehicle-density-select').value;
        if(sel === 'custom') {
            from = new Date(document.getElementById('density-from').value);
            to = new Date(document.getElementById('density-to').value);
        } else {
            to = data.length > 0 ? data[data.length-1].time : new Date();
            from = new Date(to.getTime() - parseInt(sel)*60000);
        }
        const filtered = data.filter(d => d.time >= from && d.time <= to);

        // z.B. alle 5 Minuten aufsummieren
        const bins = {};
        filtered.forEach(d => {
            const bin = new Date(Math.floor(d.time.getTime()/300000)*300000).toISOString();
            bins[bin] = (bins[bin]||0)+1;
        });
        const x = Object.keys(bins).map(t=>new Date(t));
        const y = Object.values(bins);

        const trace = {
            x: x,
            y: y,
            type: 'scatter',
            mode: 'lines+markers',
            line: {color: '#143e74'}
        };
        const layout = {
            title: 'Fahrzeugdichte (je 5 Minuten)',
            xaxis: {title: 'Zeit'},
            yaxis: {title: 'Fahrzeuge je 5 Minuten'},
            plot_bgcolor: '#f8fbff',
            paper_bgcolor: '#fff'
        };
        Plotly.newPlot('vehicle-density', [trace], layout);
    }
    document.getElementById('vehicle-density-select').addEventListener('change', function() {
        document.getElementById('vehicle-density-custom-controls').style.display = this.value==='custom' ? '' : 'none';
    });
    drawVehicleDensity();
    </script>
</body>
</html>
